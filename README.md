# IOMICS Causal Pipeline (IoCP)

This repository contains the source code for the DoWhy-based pipeline to perform effect estimation using the following general methodology:

<img width="1000" height="135" alt="image" src="https://github.com/user-attachments/assets/3c2fc122-bcdb-4c5a-b6c2-49bb3b5ac780" />

1. Model a causal inference problem using assumptions → defining a causal graphical model
2. Refute the causal graph once discovered or given
3. Identify an expression for the causal effect under those assumptions
4. Estimate the effect using the estimand expression found in the previous step
5. Finally, verify the validity of the estimate using a variety of robustness checks.

### Motivation

To understand the causal effect of a (treatment) variable on an (outcome) variable, we need to first construct a causal graphical model that explains the underlying data generating process. In doing so, the aim is to evaluate interventions (manipulations of a variable) and ultimately estimate the effect of the treatment variable on the outcome.
It would be simple if we could just perform a randomized control trial (RCT) to control for confounding variables and thereby determine a measure of causality between a treatment and outcome. However, there are many domains where only observational data exists - data that already exists via records.

### Preliminary Code Setup

```bash
conda create --name iocp python=3.11
conda activate iocp
python -m pip install -r requirements.txt
```

### Source Code Functionality

`CausalModule.py` contains all the function calls required to run the pipeline.

A boiler-plate version to run the full pipeline for a given dataset is presented in `run_effect_estimation.py`. Feel free to make changes as needed.

### Pipeline Outputs

There are two main varieties of outputs that come as a result of running the pipeline:

1. `outputs/pipeline_output.txt`: All the intermediary logged information about the pipeline are stored in this file, note that this file gets overwritten at each run
2. `outputs/results/*.csv`
   - `effect_estimate.csv`:  
     Contains the estimated causal effect(s) for the specified treatment and outcome variables, along with the realized estimand estimand and relevant metadata.
   - `estimate_refutation.csv`:  
     Summarizes the results of robustness checks and refutation tests performed on the estimated effect, helping to assess the reliability of the findings.
   - `graph_properties.csv`:  
     Stores information about the discovered or provided causal graph, including node and edge details.
   - `graph_quality.csv`:
     Contains the confusion matrix as a result of the graph quality metric that is obtained from pgmpy -- **this is the main metric to measure graph quality for now**.
   - `graph_refutation.csv`:
     Stores the outputs of the graph refuter that is displayed from DoWhy (TPA, TPA pval, LMC, LMC pval)

These outputs are generated automatically after running the pipeline and can be found in the `outputs/` directory.


| Function Name                       | Inputs / Parameters                                                                                                                                                                | Outputs / Returns                                                                                     | Purpose / Description                                                                                                                                               | Prerequisites / Notes                                                              |
| ----------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------- |
| `__init__`                          | `data=None` (pandas DataFrame), `discovery_algorithm=None` (str), `treatment_variable=None` (str), `outcome_variable=None` (str), `treatment_value=None`, `control_value=None`     | None (initializes instance variables)                                                                 | Initialize module with data and causal analysis parameters.                                                                                                         | Data should be pandas DataFrame with treatment and outcome variables as columns    |
| `find_causal_graph`                 | `algo='pc'` (str), `pk=None` (dict with 'required' and/or 'forbidden' edges)                                                                                                       | NetworkX DiGraph representing causal graph                                                            | Run causal discovery using specified algorithm (`pc`, `ges`, `icalingam`) and apply prior knowledge if provided.                                                    | Data must be provided; prior knowledge (if any) must be dict                       |
| `input_causal_graph`                | `graph` (NetworkX DiGraph)                                                                                                                                                         | The input graph                                                                                       | Accept a user-provided causal graph instead of running discovery.                                                                                                   | Graph must be NetworkX DiGraph with nodes matching data columns                    |
| `refute_cgm`                        | `n_perm=100` (int), `apply_sugst=True` (bool), `show_plt=False` (bool)                                                                                                             | Refuted causal graph (NetworkX DiGraph)                                                               | Refute the causal graph by permutation tests and optionally apply suggested graph modifications.                                                                    | Causal graph and data must be available                                            |
| `create_model`                      | None (uses instance variables)                                                                                                                                                     | Dowhy `CausalModel` object                                                                            | Creates DoWhy causal model from graph, treatment, outcome, and data.                                                                                                | Causal graph, data, treatment and outcome variables must be set                    |
| `identify_effect`                   | `method=None` (str or None, options include `'maximal-adjustment'`, `'minimal-adjustment'`, `'exhaustive-search'`, `'default'`)                                                    | Dowhy IdentifiedEstimand object                                                                       | Identifies causal effect estimand based on causal model and chosen identification method.                                                                           | Must call `create_model` first                                                     |
| `estimate_effect`                   | `method_cat='backdoor.linear_regression'` (str), `ctrl_val=None`, `trtm_val=None`                                                                                                  | Dowhy EffectEstimate object                                                                           | Estimates treatment effect using identified estimand and specified estimation method.                                                                               | Must call `identify_effect` first; treatment/control values must be set            |
| `refute_estimate`                   | `method_name="ALL"` (str: `"placebo_treatment_refuter"`, `"random_common_cause"`, `"data_subset_refuter"`, `"ALL"`), `placebo_type='permute'` (str), `subset_fraction=0.9` (float) | Dowhy RefutationResult object or list of such objects                                                 | Performs refutation tests on effect estimates to check robustness.                                                                                                  | Effect estimate must be available                                                  |
| `see_graph_properties`              | None                                                                                                                                                                               | dict of graph metrics (e.g. num\_nodes, num\_edges, paths, Markov blankets)                           | Extracts and logs properties of causal graph.                                                                                                                       | Causal graph and treatment/outcome variables must be set                           |
| `see_graph`                         | None                                                                                                                                                                               | None (displays graph visualization)                                                                   | Visualizes the causal graph.                                                                                                                                        | Causal graph must be available                                                     |
| `_extract_graph_refutation_metrics` | `graph_ref_str` (str or convertible to str)                                                                                                                                        | Tuple: (TPA\_num, TPA\_total, TPA\_pval, LMC\_num, LMC\_total, LMC\_pval)                             | Parses graph refutation output string to extract key metrics.                                                                                                       | Graph refutation results must be available                                         |
| `_extract_graph_quality_score`      | `graph` (NetworkX DiGraph), `data` (DataFrame), `test='pearsonr'` (str), `significance_level=0.05` (float), `score=confusion_matrix`                                               | Graph quality score (float or structured output)                                                      | Computes graph quality score using pgmpy correlation metrics.                                                                                                       | Graph and data must be provided                                                    |
| `see_graph_quality_score`           | None                                                                                                                                                                               | None (logs graph quality score)                                                                       | Logs graph quality score using `_extract_graph_quality_score`.                                                                                                      | Causal graph and data must be available                                            |
| `see_graph_refutation`              | None                                                                                                                                                                               | None (logs refutation metrics)                                                                        | Logs metrics from graph refutation results.                                                                                                                         | Graph refutation results must be available                                         |
| `_extract_refuter_metrics`          | `refuter_result` (str or convertible to str)                                                                                                                                       | Tuple: (p-value, new effect estimate as string)                                                       | Extracts p-value and new effect estimate from refuter output string.                                                                                                | Estimate refutation results must be available                                      |
| `see_estimate_refutation`           | None                                                                                                                                                                               | None (logs estimate refutation metrics)                                                               | Logs refutation metrics from effect estimate refutation.                                                                                                            | Estimate refutation results must be available                                      |
| `_extract_effect_estimation`        | `estimate_obj` (DoWhy EffectEstimate object)                                                                                                                                       | dict with keys: 'Effect Estimate', 'Realized Estimand Expression', 'Treatment Value', 'Control Value' | Extracts main effect estimate metrics from DoWhy EffectEstimate object.                                                                                             | Effect estimate must be available                                                  |
| `see_effect_estimation`             | None                                                                                                                                                                               | None (logs effect estimation metrics)                                                                 | Logs effect estimation metrics extracted from the estimate object.                                                                                                  | Effect estimate must be available                                                  |
| `_extract_node_quality_score`       | `node_name` (str)                                                                                                                                                                  | float node quality score                                                                              | Calculates node-level quality score based on mismatches in graph quality summary.                                                                                   | Graph quality score and summary must be calculated                                 |
| `see_node_quality_score`            | `node_name` (str)                                                                                                                                                                  | None (logs node quality score)                                                                        | Logs the quality score of a specific node.                                                                                                                          | Node quality score must be available                                               |
| `simulate_intervention`             | `variable_to_intervene` (str or None, default None uses treatment variable), `intervention_value` (value), `num_samples_to_draw=100` (int)                                         | DataFrame with samples from interventional distribution                                               | Simulates an intervention on a variable and returns samples from the interventional distribution using DoWhy’s probabilistic causal model.                          | Causal graph and data must be available                                            |
| `store_results`                     | `dir_path='outputs/results'` (str)                                                                                                                                                 | None (saves multiple CSV files and stores results dict)                                               | Stores causal graph properties, refutation metrics, quality scores, effect estimates, refutation results, and interventional samples to disk and in `self.results`. | At least some results (graph, refutation, estimates, or samples) must be available |
